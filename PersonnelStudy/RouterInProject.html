<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从项目切入，浅谈react-router的使用及HashRouter的内部机制 | 爬坑中的王小二</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/blog/image/favicon.ico">
    <meta name="description" content="个人的一些总结，随意写写">
    
    <link rel="preload" href="/blog/assets/css/0.styles.75b0cbf8.css" as="style"><link rel="preload" href="/blog/assets/js/app.dd524133.js" as="script"><link rel="preload" href="/blog/assets/js/2.5687907e.js" as="script"><link rel="preload" href="/blog/assets/js/10.bf869da4.js" as="script"><link rel="prefetch" href="/blog/assets/js/11.91bf9c55.js"><link rel="prefetch" href="/blog/assets/js/12.2f643498.js"><link rel="prefetch" href="/blog/assets/js/13.14ba96b5.js"><link rel="prefetch" href="/blog/assets/js/14.fab6c0ef.js"><link rel="prefetch" href="/blog/assets/js/15.5a53bf95.js"><link rel="prefetch" href="/blog/assets/js/3.a3bc1a65.js"><link rel="prefetch" href="/blog/assets/js/4.a5cccfda.js"><link rel="prefetch" href="/blog/assets/js/5.bfef3080.js"><link rel="prefetch" href="/blog/assets/js/6.2d0a63f8.js"><link rel="prefetch" href="/blog/assets/js/7.d38e45ce.js"><link rel="prefetch" href="/blog/assets/js/8.5b45d7e2.js"><link rel="prefetch" href="/blog/assets/js/9.acb11d62.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.75b0cbf8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">爬坑中的王小二</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/JSRedBook/Base.html" class="nav-link">
  博客
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/JSRedBook/Base.html" class="nav-link">
  博客
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript高级程序设计笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React Hooks</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>个人的零零碎碎的总结</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/PersonnelStudy/RouterInProject.html" aria-current="page" class="active sidebar-link">从项目切入，浅谈react-router的使用及HashRouter的内部机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/PersonnelStudy/RouterInProject.html#为何想写这篇博文" class="sidebar-link">为何想写这篇博文？</a></li><li class="sidebar-sub-header"><a href="/blog/PersonnelStudy/RouterInProject.html#对于已有的window-location-href问题要怎么解决" class="sidebar-link">对于已有的window.location.href问题要怎么解决？</a></li><li class="sidebar-sub-header"><a href="/blog/PersonnelStudy/RouterInProject.html#从项目整体切入-看看我们的router是怎么运作的" class="sidebar-link">从项目整体切入，看看我们的Router是怎么运作的</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/PersonnelStudy/RouterInProject.html#分析我们项目的目录结构" class="sidebar-link">分析我们项目的目录结构</a></li><li class="sidebar-sub-header"><a href="/blog/PersonnelStudy/RouterInProject.html#browserrouter-hashrouter" class="sidebar-link">BrowserRouter &amp;&amp; HashRouter</a></li><li class="sidebar-sub-header"><a href="/blog/PersonnelStudy/RouterInProject.html#router的实现" class="sidebar-link">Router的实现</a></li><li class="sidebar-sub-header"><a href="/blog/PersonnelStudy/RouterInProject.html#从传入的history对象-初步来分析history库" class="sidebar-link">从传入的history对象，初步来分析history库</a></li><li class="sidebar-sub-header"><a href="/blog/PersonnelStudy/RouterInProject.html#history库用到的工具类" class="sidebar-link">history库用到的工具类</a></li><li class="sidebar-sub-header"><a href="/blog/PersonnelStudy/RouterInProject.html#聊完工具类-再看history对象中的属性" class="sidebar-link">聊完工具类，再看history对象中的属性</a></li><li class="sidebar-sub-header"><a href="/blog/PersonnelStudy/RouterInProject.html#说一下renderroutes" class="sidebar-link">说一下renderRoutes</a></li><li class="sidebar-sub-header"><a href="/blog/PersonnelStudy/RouterInProject.html#再看一下route组件" class="sidebar-link">再看一下Route组件</a></li><li class="sidebar-sub-header"><a href="/blog/PersonnelStudy/RouterInProject.html#withrouter-react-router-hooks" class="sidebar-link">WithRouter &amp;&amp; React Router Hooks</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="从项目切入-浅谈react-router的使用及hashrouter的内部机制"><a href="#从项目切入-浅谈react-router的使用及hashrouter的内部机制" class="header-anchor">#</a> 从项目切入，浅谈react-router的使用及HashRouter的内部机制</h1> <h2 id="为何想写这篇博文"><a href="#为何想写这篇博文" class="header-anchor">#</a> 为何想写这篇博文？</h2> <p>在我们组内的开发中，看到我们的现有的路由跳转的方式，很多都是使用window.location.href，历史原因导致很多代码都是这么写的。这种方式对于调试不够友好。（这是由于我们自己公司的工程配置，在线上环境下必须要加前缀，而本地调试的时候又必须要手动去掉前缀。例如我们组的卖家中心项目就是/seller#/，而这样是代理到了代理环境，而不是开发环境本身。）React是有三件套的，React、React-Router、Redux（以及Mobx等为代表的其它状态管理工具）。然而在我们项目中，用React-Router进行路由跳转的方式为之甚少。所以这引发了我的兴趣，便想把这个查清楚一些。</p> <h2 id="对于已有的window-location-href问题要怎么解决"><a href="#对于已有的window-location-href问题要怎么解决" class="header-anchor">#</a> 对于已有的window.location.href问题要怎么解决？</h2> <p>首先需要声明一个范围（免责声明），只对于同一个项目中由Router管控的页面可以这么跳，其它的不适用React-Router的跳转。</p> <p>如果有上面的免责声明的限制，那么我们就可以对已有的项目进行如下改造。下面分两种情况进行讨论：</p> <ul><li>如果是类组件，使用WithRouter</li></ul> <p>withRouter是一个高阶组件，它会把类组件包装成一个高阶组件，在原来的基础上添加react-router的match、history、location三个对象（其实还有staticContext，只有SSR服务端的时候会用到这个属性）到我们的类组件中。这样对于我们层级较深的，没有直接和外层路由相连的组件，我们也可以直接对其进行路由操作。</p> <p>下面我们举例子来看这个的用法：</p> <p>1.首先，我们要把withRouter和RouterComponentProps导入进来。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> RouteComponentProps<span class="token punctuation">,</span> withRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-dom'</span><span class="token punctuation">;</span>
</code></pre></div><p>2.其次，我们要改变类组件的声明，需要继承RouteComponentProps。这样ts的类型检测才不会报错，否则后面我们用到props属性的时候，是拿不到history对象的。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>
<span class="token keyword">interface</span> <span class="token class-name">IListDemoProps</span> <span class="token keyword">extends</span> <span class="token class-name">RouteComponentProps<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  demoStore<span class="token operator">:</span> DemoStore<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 这里我们不能直接export出去，因为我们还需要用withRouter进行高阶组件的封装。</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">observer</span></span>
<span class="token keyword">class</span> <span class="token class-name">ListDemo</span> <span class="token keyword">extends</span> <span class="token class-name">React</span><span class="token punctuation">.</span>Component<span class="token operator">&lt;</span>IListDemoProps<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ....里面是类的方法</span>
<span class="token punctuation">}</span>
</code></pre></div><p>3.再次，<strong>是我们的核心</strong>。将history对象从我们的属性中解构出来，然后使用push方法进行路由的替换。</p> <p>变更前：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/demo-href#/demo-edit?code=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;type=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">// demo-href代表线上的前缀名</span>
</code></pre></div><p>变更后：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> history <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/demo-edit?code=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;type=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>4.最后，使用withRouter形成一个高阶组件。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">withRouter</span><span class="token punctuation">(</span>ListDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注：withRouter的使用范围有两个限制。</p> <p>​       第一个是类组件，只有在类组件中才能使用。</p> <p>​       第二个是不直接与主页面的路由相连，才需要用withRouter高阶组件。如果当前的组件由Router直接管控，则直接使用属性上的history对象进行跳转即可，不需要用withRouter添加路由对象进去。</p> <ul><li>如果是Hooks组件，使用useHistory</li></ul> <p>React在16.8版本后推出了React Hooks，所以我们又多了一种写组件的方法，即Hooks组件。与之对应，我们也要对路由跳转的方法进行变更，所以useHistory横空出世。（注意：只有16.8之后的版本，且组件为Hooks组件才可以使用这个方法）</p> <p>下面我们来看看useHistory在函数组件中是怎么使用的。</p> <p>1.首先我们引入useHistory。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-dom'</span>
</code></pre></div><p>2.我们可以在函数组件声明一个对象，用来获取当前的路由。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 当前路由，执行这个方法就得到了一个当前路由的实例</span>
<span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token function">useHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后，我们可以看一下这个对象里面有什么。</p> <img src="https://i.ibb.co/mXRdZjx/history-content.png"> <p>3.获取到这个路由对象我们就可以全局来进行使用。如下是两个使用示例，也可以结合hooks来进行使用。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/**
  * 取消操作
  */</span>
<span class="token keyword">const</span> <span class="token function-variable function">cancel</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/demo/list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/** 保存成功操作 **/</span>
<span class="token keyword">const</span> <span class="token function-variable function">saveSuccess</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 前面还有部分业务代码，不主要，省略 //</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'保存成功'</span><span class="token punctuation">)</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/demo/list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>如果跳转路由方法写到store里面，我们需要想办法放到组件执行</li></ul> <p>这里依然有一个历史问题要说明一下，我们的状态管理库用的是Mobx，而且很多的路由跳转都是在Mobx的类中进行的。所以这里就有一个很难解决的问题。我们应该怎样把这个&quot;不正经&quot;的路由切换方式，调整为我们需要的方式呢？对于这个问题，我有以下的两个思路来解决。</p> <ol><li><p>将路由的跳转作为回调函数，从而解决此问题。</p> <p>比如这里的代码。</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">/** DemoInfo.tsx **/</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> withRouter<span class="token punctuation">,</span> RouteComponentProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> DemoConfirm <span class="token keyword">from</span> <span class="token string">'./components/demo-confirm'</span><span class="token punctuation">;</span>
<span class="token keyword">interface</span> <span class="token class-name">IDemoProps</span> <span class="token keyword">extends</span> <span class="token class-name">RouteComponentProps<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  demoStore<span class="token operator">:</span> DemoStore<span class="token punctuation">;</span> <span class="token comment">// contractManagePageSore</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">observer</span></span>
<span class="token keyword">class</span> <span class="token class-name">DemoInfo</span> <span class="token keyword">extends</span> <span class="token class-name">React</span><span class="token punctuation">.</span>Component<span class="token operator">&lt;</span>IDemoProps<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>  
  <span class="token comment">/**
   * 提交页面数据
   */</span>
  <span class="token function">submitInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> demoStore <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token comment">/** 保存成功时的回调函数，设置并传入到store里面去 */</span>
    <span class="token keyword">const</span> <span class="token function-variable function">submitSuccessCallback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/contract-manage'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">/** 将回调函数作为参数进行传入，然后我们就可以进行调用 **/</span> 
    demoStore<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>submitSuccessCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
    
  <span class="token comment">/** 渲染 **/</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>  
      	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">DemoConfirm</span></span>
        	<span class="token attr-name">closeModal</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> contractManagePageSore<span class="token punctuation">.</span><span class="token function">toggleConfirmLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
        	<span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>contractManagePageSore<span class="token punctuation">}</span></span>
        	<span class="token attr-name">submit</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">submitContractManage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
      	<span class="token punctuation">/&gt;</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">withRouter</span><span class="token punctuation">(</span>ContractorInformation<span class="token punctuation">)</span>

<span class="token comment">/** DemoStore.ts **/</span> 
<span class="token keyword">class</span> <span class="token class-name">DemoStore</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">action</span></span>
  <span class="token keyword">async</span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果调用成功，就走跳转路由的回调函数</span>
        <span class="token comment">// 这里只是个示例，其实还有其它的处理</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>将路由跳转的操作（点击、悬浮、失焦等和组件相关的）和数据的组装抽离开来。store中专职处理数据的封装，操作等还是放到组件来进行。</p></li></ol> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">/** Demo.tsx**/</span>
<span class="token keyword">interface</span> <span class="token class-name">IDemoStore</span> <span class="token keyword">extends</span> <span class="token class-name">RouteComponentProps<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
demoStore<span class="token operator">:</span> DemoStore<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">observer</span></span>
<span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token keyword">extends</span> <span class="token class-name">React</span><span class="token punctuation">.</span>Component<span class="token operator">&lt;</span>IDemoStore<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> demo<span class="token punctuation">,</span> history <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token comment">/** 取消方法，原来在store中的 */</span>
  <span class="token keyword">const</span> <span class="token function-variable function">cancel</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/demo-list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">/** 保存方法，原来在store中的 **/</span>
  <span class="token keyword">const</span> <span class="token function-variable function">save</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> param <span class="token operator">=</span> <span class="token function">getParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">saveInfo</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'保存成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/demo-list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'保存失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span>
        <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>save<span class="token punctuation">}</span></span>
      <span class="token punctuation">&gt;</span></span><span class="token plain-text">
        保存
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Button</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span> <span class="token attr-name">outline</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>cancel<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        取消
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Button</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">withRouter</span><span class="token punctuation">(</span>Operation<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/** DemoStore.ts **/</span>
<span class="token keyword">class</span> <span class="token class-name">DemoStore</span> <span class="token punctuation">{</span>
<span class="token comment">/** 获取保存的参数 * */</span>
<span class="token function-variable function">getParam</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shareId<span class="token punctuation">,</span>
    shareStartTime<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startTime<span class="token operator">?.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
    shareEndTime<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endTime<span class="token operator">?.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
    remark<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>remark <span class="token operator">||</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="从项目整体切入-看看我们的router是怎么运作的"><a href="#从项目整体切入-看看我们的router是怎么运作的" class="header-anchor">#</a> 从项目整体切入，看看我们的Router是怎么运作的</h2> <h3 id="分析我们项目的目录结构"><a href="#分析我们项目的目录结构" class="header-anchor">#</a> 分析我们项目的目录结构</h3> <p>从我们的项目来看，都用的是哈希路由（即HashRouter)。我们的脚手架创建出来的入口文件app.tsx，差不多是这样的一个结构。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Provider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'mobx-react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HashRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-config'</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">'./config/route'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> stores <span class="token keyword">from</span> <span class="token string">'./config/stores'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'./styles/index.scss'</span><span class="token punctuation">;</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>HashRouter<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>Provider <span class="token punctuation">{</span><span class="token operator">...</span>stores<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token function">renderRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>HashRouter<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里我们不免对HashRouter的内部构造有一些兴趣，于是我们打开它的内部构造，结果发现了更玄妙的东西。</p> <p>我们所知道的是，React提供了两种路由的方式，BrowserRouter和HashRouter（表面上看是带哈希符号即#和不带哈希符号的区别），react-router对它们处理方式也会有所不同。</p> <h3 id="browserrouter-hashrouter"><a href="#browserrouter-hashrouter" class="header-anchor">#</a> BrowserRouter &amp;&amp; HashRouter</h3> <p>这里简单介绍一下他俩的区分吧：</p> <ul><li>BrowserRouter在路径表现上无#，看起来是比较美观的。而HashRouter带#，看起来有点丑。</li> <li>BrowserRouter需要服务器渲染支持，不可单独由前端控制渲染。而HashRouter是由前端来进行控制渲染，不可走服务端渲染。二者是相反的。</li></ul> <p>以下代码只保留了主干部分。这里我们可以看到它们的代码结构几乎一模一样，区别只在于传入的history属性的方法不一样而已。都使用了history这个库，通过传入的history方法来判断是BrowserRouter还是HistoryRouter。</p> <p>BrowserRouter源码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Router <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createBrowserHistory <span class="token keyword">as</span> createHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;history&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">BrowserRouter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  history <span class="token operator">=</span> <span class="token function">createHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Router history<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">}</span> children<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> BrowserRouter<span class="token punctuation">;</span>
</code></pre></div><p>HashRouter源码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Router <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createHashHistory <span class="token keyword">as</span> createHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;history&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HashRouter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  history <span class="token operator">=</span> <span class="token function">createHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Router history<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">}</span> children<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> HashRouter<span class="token punctuation">;</span>
</code></pre></div><p>我们先看看Router给我们做了什么工作吧。然后我们会以createHashHistory为例，来进行history库的一些解读。</p> <h3 id="router的实现"><a href="#router的实现" class="header-anchor">#</a> Router的实现</h3> <p>下面我们先放一波Router源码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> HistoryContext <span class="token keyword">from</span> <span class="token string">&quot;./HistoryContext.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> RouterContext <span class="token keyword">from</span> <span class="token string">&quot;./RouterContext.js&quot;</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Router就是记录路由状态的context，它是一个组件，用于给它下面的子节点提供数据支撑
 */</span>
<span class="token keyword">class</span> <span class="token class-name">Router</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">computeRootMatch</span><span class="token punctuation">(</span><span class="token parameter">pathname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">isExact</span><span class="token operator">:</span> pathname <span class="token operator">===</span> <span class="token string">&quot;/&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">location</span><span class="token operator">:</span> props<span class="token punctuation">.</span>history<span class="token punctuation">.</span>location
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 设定了加载的状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_pendingLocation <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 缓存的路由，当初次加载的时候，会使用这个路由</span>
	  <span class="token comment">// 这里其实BrowserRouter和HashRouter都走这里，它们都不是静态上下文。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>props<span class="token punctuation">.</span>staticContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>unlisten <span class="token operator">=</span> props<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">location</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> location <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_pendingLocation <span class="token operator">=</span> location<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_pendingLocation<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">location</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_pendingLocation <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>unlisten<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unlisten</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_pendingLocation <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token comment">// Provider主要的功能就是为子组件提供数据支持，以便于子组件进行获取、更改、跳转。</span>
      <span class="token operator">&lt;</span>RouterContext<span class="token punctuation">.</span>Provider
        value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
          <span class="token literal-property property">history</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>history<span class="token punctuation">,</span> <span class="token comment">// 即外部传入的history属性</span>
          <span class="token literal-property property">location</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>location<span class="token punctuation">,</span> <span class="token comment">// 当前被设置的location</span>
          <span class="token literal-property property">match</span><span class="token operator">:</span> Router<span class="token punctuation">.</span><span class="token function">computeRootMatch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 提供匹配的默认值，防止找不到匹配的组件，发生错误</span>
          <span class="token literal-property property">staticContext</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>staticContext <span class="token comment">// 如果是BrowserRouter和HashRouter其实都是null</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>HistoryContext<span class="token punctuation">.</span>Provider
          children<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">}</span> <span class="token comment">// children其实就是需要渲染的内容</span>
          value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>history<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>RouterContext<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Router<span class="token punctuation">;</span>
</code></pre></div><p>下面我们从属性定义、生命周期函数、最终渲染三个维度来进行分析：</p> <ul><li><p>属性定义：</p> <ul><li><p>引入的两个Context（RouterContext、HistoryContext）的作用：给子组件传递上下文，并提供属性给它们。从而子组件就能拿到它们传递的属性。</p></li> <li><p>computeRootMatch：这个方法给了一个默认值，用于在匹配不到路由的时候进行默认的显示。</p></li> <li><p>状态：即location。记录的是当前所在的地址。</p></li> <li><p>_isMounted：记录是否页面已经加载过路由。是一个标志位。</p></li> <li><p>_pendingLocation：缓存的地址。初次加载路由的时候会用到这个值。如果没有加载路由，会将location状态初始化为这个路由。</p></li> <li><p>unlisten：解除路由监听方法。是监听方法的返回值。当调用这个方法的时候，会解除对路由的监听。这里为啥unlisten方法是这样的？下面讲history库的时候会有说明，会解答这个问题。</p></li></ul></li> <li><p>生命周期函数</p> <ul><li>constructor：this.unlisten在这里注册了一个监听函数，如果已挂载，则当页面位置(回调函数参数)发生变化的时候，设置location为这个值。否则未挂载的话，就设置缓存的路由值为当前页面位置(回调函数参数)。写在contructor的原因是：子组件如果有Redirect的时候，我们知道，组件的挂载顺序是由子组件到父组件的，那么如果我们不在构造函数里面就进行监听的话，Redirect组件挂载完了，就直接跳转走了，父组件监听不到它的变化。所以这里将监听函数放在contructor里，其实是一种hack的写法，但是却也不得不为之。</li> <li>componentDidMount：组件挂载。这里我们做的工作是，设置挂载状态为true，如果有缓存的路由值，那我们就把状态中的location值更新成这个值。</li> <li>componentWillUnmount：组件卸载。这里我们做的工作是，取消对路由的监听，然后设置挂载状态为false，清空缓存的路由值。</li></ul></li> <li><p>最终渲染</p> <p>这里的最终渲染无非就是给下面的子组件提供了数据支撑，便于子组件进行获取、更改、跳转。详细的参见注释中的内容。</p></li></ul> <h3 id="从传入的history对象-初步来分析history库"><a href="#从传入的history对象-初步来分析history库" class="header-anchor">#</a> 从传入的history对象，初步来分析history库</h3> <p>下面我们来单独说说这个传入的history对象，提到这个对象我们先来说说history这个库。</p> <p>其实history这个库是相当于在原有的HTML5的history对象基础上，再加了一层封装。它不止适用于react项目中，也可以单独拿出来进行使用。下面我们来看一下这个对象返回给了我们什么内容。先看注释，然后再来详细拆解其中的实现。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>  <span class="token comment">// 这个history就是它返回的值</span>
  <span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token punctuation">{</span>
    length<span class="token operator">:</span> globalHistory<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token comment">// 等同于window.history.length</span>
    action<span class="token operator">:</span> <span class="token string">'POP'</span><span class="token punctuation">,</span> <span class="token comment">// history的动作，枚举值REPLACE、POP、PUSH</span>
    location<span class="token operator">:</span> initialLocation<span class="token punctuation">,</span> <span class="token comment">// 当前所在的路径对象，属性有:pathname、search、hash、state</span>
    createHref<span class="token punctuation">,</span> <span class="token comment">// 是一个创建哈希路径的方法</span>
    push<span class="token punctuation">,</span> <span class="token comment">// 跳转一个新地址，并将新地址入栈</span>
    replace<span class="token punctuation">,</span> <span class="token comment">// 将当前页面替换成一个新地址</span>
    go<span class="token punctuation">,</span> <span class="token comment">// 等同于window.history.go</span>
    goBack<span class="token punctuation">,</span> <span class="token comment">// 等同于window.history.go(-1)</span>
    goForward<span class="token punctuation">,</span> <span class="token comment">// 等同于window.history.go(1)</span>
    block<span class="token punctuation">,</span> <span class="token comment">// 阻止并提示的方法</span>
    listen <span class="token comment">// 监听路由变化的方法</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="history库用到的工具类"><a href="#history库用到的工具类" class="header-anchor">#</a> history库用到的工具类</h3> <p>在我们处理history对象的过程中，我们需要用到一个工具类函数，这个工具函数对应到源码中，是写在createTransitionManager.js这个文件中的。先看一下这个函数大体的轮廓是什么样子的吧。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">createTransitionManager</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> prompt <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setPrompt</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">nextPrompt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token function-variable function">confirmTransitionTo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">,</span> action<span class="token punctuation">,</span> getUserConfirmation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> <span class="token function-variable function">appendListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token function-variable function">notifyListeners</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    setPrompt<span class="token punctuation">,</span>
    confirmTransitionTo<span class="token punctuation">,</span>
    appendListener<span class="token punctuation">,</span>
    notifyListeners
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> createTransitionManager
</code></pre></div><p>我们可以看出，这个工具类里面，提供了四个方法供外部进行调用。并且有两个内部共享的属性。</p> <ul><li><p>prompt：记录提示的内容，根据提示内容的不同，从而进行不同方式的阻止操作。</p></li> <li><p>setPrompt：设置提示。这里接收的prompt的值的类型有点复杂，可以是布尔值、字符串、函数或者是null。默认值是false(从history实例上的block方法传过来的。代表含义是单纯的阻止，啥都不给提示)。如果是字符串或者函数代表的是提示内容，根据他们类型的不同，从而进行不同的提示。如果是null的话，则证明不进行阻止。我们可以看一下这里面是咋实现的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/** 设置提示 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">setPrompt</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">nextPrompt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">warning</span><span class="token punctuation">(</span>
    prompt <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">'A history supports only one prompt at a time'</span>
  <span class="token punctuation">)</span>

  prompt <span class="token operator">=</span> nextPrompt

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prompt <span class="token operator">===</span> nextPrompt<span class="token punctuation">)</span>
      prompt <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>warning是一个从外部导入的控制台提示库，如果前面的条件不符合，则提示后面的内容。其实这个工具类很简单，就是设置一个提示的值，然后返回一个闭包供清除提示，恢复成原来的值即可。我们一直都在说提示，也说提示有两种方式，看看history库官方给我们的用法，具体这个函数长啥样。（nextPrompt是从block方法传过来的，所以这里给的示例是block函数的）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Register a simple prompt message that will be shown the</span>
<span class="token comment">// user before they navigate away from the current page.</span>
<span class="token keyword">const</span> unblock <span class="token operator">=</span> history<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token string">'Are you sure you want to leave this page?'</span><span class="token punctuation">)</span>

<span class="token comment">// Or use a function that returns the message when it's needed.</span>
history<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// The location and action arguments indicate the location</span>
  <span class="token comment">// we're transitioning to and how we're getting there.</span>

  <span class="token comment">// A common use case is to prevent the user from leaving the</span>
  <span class="token comment">// page if there's a form they haven't submitted yet.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span>value <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'Are you sure you want to leave this page?'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>然后我们说的提示的具体模样就是下一张图，与window.confirm的参数类型是一样的。</p> <img src="https://developer.mozilla.org/en-US/docs/Web/API/Window/confirm/firefoxcomfirmdialog_zpsf00ec381.png"></li> <li><p>confirmTransitionTo 确认是否跳转。该函数的名字的含义也很明确，就是根据提示内容的状态来确定是否变化路由。我们来看一下这里的代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/** 确认是否跳转 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">confirmTransitionTo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">,</span> action<span class="token punctuation">,</span> getUserConfirmation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO: If another transition starts while we're still confirming</span>
  <span class="token comment">// the previous one, we may end up in a weird state. Figure out the</span>
  <span class="token comment">// best way to handle this.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>prompt <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行弹窗内容，获取弹窗内容结果</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">typeof</span> prompt <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">prompt</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token operator">:</span> prompt
    <span class="token comment">// 当弹窗的内容是string的时候，一般调用prompt之后，返回的都是string</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> result <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 用户提示是函数，就执行</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> getUserConfirmation <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">getUserConfirmation</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">warning</span><span class="token punctuation">(</span>
          <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token string">'A history needs a getUserConfirmation function in order to use a prompt message'</span>
        <span class="token punctuation">)</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Return false from a transition hook to cancel the transition.</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>result <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// 否则，用户取消时，回调的值返回了false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面我们谈到了prompt的四个类型的值，所以这里的逻辑判断其实就比较清晰了。</p> <ul><li><p>prompt不为null(这里排除了undefined，因为block函数默认值是false)，那就证明，我们有需要提示的内容，暂时需要阻拦一下。上面我们提过了，有两种prompt的方式，所以这里要判断是函数还是字符串，目的都是拿到这个执行的结果，都是字符串（一种情况除外，用户取消的时候，返回了false)。</p> <ul><li><p>如果这个结果是字符串的话，并且getUserConfirmation的类型为函数，那我就执行这个函数。这里getUserConfirmation这里可以展开说一下。默认情况下，如果不是createMemoryHistory的情况下（服务器渲染）的情况下，这个参数是在history对象的props里面传下来的，默认值就是调用了window.confirm来进行提示的。不信我们可以看一下createBrowserHistory和createHashHistory的参数类型。如果我们不去重写这个属性的话，那它就是用的window.confirm进行提示，然后这个会返回true/false,然后走回调函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">createBrowserHistory</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">basename</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>             <span class="token comment">// The base URL of the app (see below)</span>
  <span class="token literal-property property">forceRefresh</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      <span class="token comment">// Set true to force full page refreshes</span>
  <span class="token literal-property property">keyLength</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>             <span class="token comment">// The length of location.key</span>
  <span class="token comment">// A function to use to confirm navigation with the user (see below)</span>
  <span class="token function-variable function">getUserConfirmation</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">confirm</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">createHashHistory</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">basename</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>             <span class="token comment">// The base URL of the app (see below)</span>
  <span class="token literal-property property">hashType</span><span class="token operator">:</span> <span class="token string">'slash'</span><span class="token punctuation">,</span>        <span class="token comment">// The hash type to use (see below)</span>
  <span class="token comment">// A function to use to confirm navigation with the user (see below)</span>
  <span class="token function-variable function">getUserConfirmation</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">confirm</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>如果getUserConfirmation不是函数的话，那我们就要给一个error提示了。history对象需要一个getUserConfirmation来进行一个提示。不阻止路由执行。</p></li> <li><p>如果result的返回类型不为string，那result也就是false，那也就是阻止路由执行，这里是用户取消了提示。</p></li></ul></li> <li><p>如果prompt是null，这个是我们的初始情况。不阻止路由执行。</p></li></ul></li> <li><p>listeners 是我们需要监听的路由集合。我们的两个内部方法appendListeners和notifyListeners都用到了这个。</p> <p>listener的具体类型是这样的，下面给一个例子，它的参数值包含两个属性，location即当前位置，action即前面提到的history的动作，包含三个枚举值。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">listener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// location is an object like window.location</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> location<span class="token punctuation">.</span>pathname<span class="token punctuation">,</span> location<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>appendListeners 绑定监听函数到依赖数组中。我们来看一下这里的实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/** 绑定监听 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">appendListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 是否有效</span>
  <span class="token keyword">let</span> isActive <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token comment">// 监听事件，发送通知的时候会用到</span>
  <span class="token keyword">const</span> <span class="token function-variable function">listener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里有个状态控制，确认事件绑定的时候才有效</span>
    <span class="token comment">// 否则解绑被调用的时候，这个是不走的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isActive<span class="token punctuation">)</span>
      <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 监听数组放入监听函数</span>
  listeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
  <span class="token comment">// 这个返回值是解绑的时候需要执行的</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 标志位置为false，以及删除需要解绑的函数</span>
    isActive <span class="token operator">=</span> <span class="token boolean">false</span>
    listeners <span class="token operator">=</span> listeners<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item <span class="token operator">!==</span> listener<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里用isActive来控制是否在监听状态中，注意的是，每一个listener单独控制一个isActive。当我们appendListener的时候，会将这个listener放入到我们的listeners依赖数组中，且返回解除当前listener的方法。当我们需要解除的时候，调用解除的方法，会将isActive标志位置为false，这样我们的listener就不会再执行，然后把当前的listener从依赖数组listeners中删去。</p></li> <li><p>notifyListeners   执行每一个listener方法，更新路由当前的位置和执行的动作。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/** 发送监听通知，实际上就是执行一遍每一个listener，刷新路由 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">notifyListeners</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  listeners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">listener</span> <span class="token operator">=&gt;</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="聊完工具类-再看history对象中的属性"><a href="#聊完工具类-再看history对象中的属性" class="header-anchor">#</a> 聊完工具类，再看history对象中的属性</h3> <p>现在回过头来看我们history对象中的属性。</p> <ul><li><p>location: 当前路由所在的位置。这个是由history内部对象维护的一个状态。当哈希值改变的时候，这个值也会改变。</p></li> <li><p>createHref：这个是一个公共方法，创建一个标准的路由哈希路径。下面我们看一下源码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">createHref</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">location</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token string">'#'</span> <span class="token operator">+</span> <span class="token function">encodePath</span><span class="token punctuation">(</span>basename <span class="token operator">+</span> <span class="token function">createPath</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>很简单，一句话搞定。可是我们看到有两个不认识的东西，encodePath和createPath是啥？</p> <p>encodePath是根据history传入的哈希类型来获取的加密路径的方法，createPath是根据location来进行标准化处理，返回一个标准的路径string字符串。我们来看看这两块的代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// stripLeadingSlash 如果第一位字符是/，则把它去掉，否则不变</span>
<span class="token comment">// addLeadingSlash 与前者相反，如果没有/，则加上/，否则不变</span>
<span class="token comment">// addLeadingSlash = (path) =&gt; path.charAt(0) === '/' ? path : '/' + path</span>
<span class="token comment">// stripLeadingSlash = (path) =&gt; path.charAt(0) === '/' ? path.substr(1) : path</span>
<span class="token keyword">const</span> HashPathCoders <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 形如/#!/demo/path</span>
  <span class="token literal-property property">hashbang</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">encodePath</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'!'</span> <span class="token operator">?</span> path <span class="token operator">:</span> <span class="token string">'!/'</span> <span class="token operator">+</span> <span class="token function">stripLeadingSlash</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">decodePath</span><span class="token operator">:</span> stripLeadingSlash
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 形如/#demo/path</span>
  <span class="token literal-property property">noslash</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">encodePath</span><span class="token operator">:</span> stripLeadingSlash<span class="token punctuation">,</span>
    <span class="token literal-property property">decodePath</span><span class="token operator">:</span> addLeadingSlash
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 形如 /#/demo/path</span>
  <span class="token literal-property property">slash</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">encodePath</span><span class="token operator">:</span> addLeadingSlash<span class="token punctuation">,</span>
    <span class="token literal-property property">decodePath</span><span class="token operator">:</span> addLeadingSlash
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/** 这里是主函数的一部分 **/</span>
<span class="token keyword">const</span> <span class="token function-variable function">createHashHistory</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    getUserConfirmation <span class="token operator">=</span> getConfirmation<span class="token punctuation">,</span>
    hashType <span class="token operator">=</span> <span class="token string">'slash'</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> props
    <span class="token comment">// 根据哈希类型获取编码和解码方法</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> encodePath<span class="token punctuation">,</span> decodePath <span class="token punctuation">}</span> <span class="token operator">=</span> HashPathCoders<span class="token punctuation">[</span>hashType<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token comment">/** PathUtils.js 根据location生成标准化路径 **/</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createPath</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">location</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pathname<span class="token punctuation">,</span> search<span class="token punctuation">,</span> hash <span class="token punctuation">}</span> <span class="token operator">=</span> location
  <span class="token keyword">let</span> path <span class="token operator">=</span> pathname <span class="token operator">||</span> <span class="token string">'/'</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>search <span class="token operator">&amp;&amp;</span> search <span class="token operator">!==</span> <span class="token string">'?'</span><span class="token punctuation">)</span>
    path <span class="token operator">+=</span> <span class="token punctuation">(</span>search<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'?'</span> <span class="token operator">?</span> search <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>search<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hash <span class="token operator">&amp;&amp;</span> hash <span class="token operator">!==</span> <span class="token string">'#'</span><span class="token punctuation">)</span>
    path <span class="token operator">+=</span> <span class="token punctuation">(</span>hash<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'#'</span> <span class="token operator">?</span> hash <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hash<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> path
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>pop、push、listen、block</p> <p>有人看到这里可能会问了，这四个为啥要放到一堆儿说呢？这里的内容不是很重要么？当然很重要，没毛病。这是我们history库的核心方法，玩history库就是玩的它们。但是他们存在共同的依赖。所以要讲他们之前，我们需要把他们共同的依赖要列出来。先列依赖，然后再分别逐一击破它们。</p> <ul><li><p>依赖的公共属性和方法</p> <ul><li><p>forceNextPop</p> <p>标志位。值为true/false。这个标志我们是否有提示，需要进行阻断。</p></li> <li><p>allPaths</p> <p>数组。值为所有路径的集合。</p></li> <li><p>ignorePath</p> <p>字符串或者是null。这个标志是因为我们在push/replace的时候需要单独处理，如果存在这个标志，则有特殊处理，下面会说。</p></li> <li><p>listenerCount</p> <p>数字。记录当前在用的监听路由的数量。</p></li> <li><p>setState</p> <p>刷新当前history对象的location和action，并通知监听方法更新。别看名字和React里面的setState一样，干的根本不是同一个事。下面我们放这个方法的源码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 设置状态方法</span>
<span class="token keyword">const</span> <span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">nextState</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">/** 组装history对象 */</span>
  Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>history<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span>
  <span class="token comment">/** 重新刷新history对象的长度，与全局history对象的长度保持一致 */</span>
  history<span class="token punctuation">.</span>length <span class="token operator">=</span> globalHistory<span class="token punctuation">.</span>length
  <span class="token comment">/** 通知组件更新，调用更新方法 */</span>
  transitionManager<span class="token punctuation">.</span><span class="token function">notifyListeners</span><span class="token punctuation">(</span>
    history<span class="token punctuation">.</span>location<span class="token punctuation">,</span>
    history<span class="token punctuation">.</span>action
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里我们将history对象的方法，使用nextState更新，nextState方法里面有当前记录的location和action。然后更新history对象的长度，跟window.history对象的长度保持一致。(handleHashChange的时候，监听的是hashchange事件，window.history的值要同步过来)。然后通知全部的监听方法进行更新，刷新路由的history.location和history.action。</p></li> <li><p>handleHashChange</p> <p>这个是全局的哈希值变化的监听方法，来看一下相应的源码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 获取哈希值
 * 这里官方文档给出的不能直接用window.location.hash的原因是
 * 火狐会在解码的时候会执行预解码，表现和其它浏览器不一致
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">getHashPath</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// We can't use window.location.hash here because it's not</span>
  <span class="token comment">// consistent across browsers - Firefox will pre-decode it!</span>
  <span class="token keyword">const</span> href <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href
  <span class="token keyword">const</span> hashIndex <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> hashIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> href<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>hashIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取完整location对象</span>
<span class="token keyword">const</span> <span class="token function-variable function">getDOMLocation</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">decodePath</span><span class="token punctuation">(</span><span class="token function">getHashPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 如果存在基准url，要把基准url删掉</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>basename<span class="token punctuation">)</span>
    path <span class="token operator">=</span> <span class="token function">stripBasename</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> basename<span class="token punctuation">)</span>
  <span class="token comment">// 返回完整的location对象</span>
  <span class="token comment">// 这里返回了pathname,search,hash,state</span>
  <span class="token keyword">return</span> <span class="token function">createLocation</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 处理哈希值变化方法 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">handleHashChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">getHashPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> encodedPath <span class="token operator">=</span> <span class="token function">encodePath</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">!==</span> encodedPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Ensure we always have a properly-encoded hash.</span>
    <span class="token comment">// 确保始终拥有正确编码的哈希值，保持一致</span>
    <span class="token function">replaceHashPath</span><span class="token punctuation">(</span>encodedPath<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">getDOMLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> prevLocation <span class="token operator">=</span> history<span class="token punctuation">.</span>location
    <span class="token comment">// 如果是非弹窗状态或者是弹窗已确认的状态</span>
    <span class="token comment">// 且location中的pathname,search,hash,state均没有变化</span>
    <span class="token comment">// 那么就不处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forceNextPop <span class="token operator">&amp;&amp;</span> <span class="token function">locationsAreEqual</span><span class="token punctuation">(</span>prevLocation<span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token comment">// A hashchange doesn't always == location change.</span>
    <span class="token comment">// 如果哈希值变化了，且这个和当前地址的值相等，那么也不进行处理</span>
    <span class="token comment">// 因为我们在push/replace中处理过了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ignorePath <span class="token operator">===</span> <span class="token function">createPath</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token comment">// Ignore this change; we already setState in push/replace.</span>
    <span class="token comment">// 如果上面两种情况都不是，那么就执行下面的方法</span>
    ignorePath <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token function">handlePop</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里我们先比较了一波path和编码之后的encodePath是否相等，如果不等直接替换，替换完事之后，如果还处于监听状态的话（注意后面要说的checkDOMListeners），那么还是会走入下面的方法。所以重点分析else里面的逻辑。</p> <p>这里的比较：</p> <ul><li>是非需要阻断状态，且当前的位置和之前的位置相等，则证明它不需要刷新。</li> <li>当前的位置在转成字符串路径之后和ignorePath相等的话，则证明它需要单独在replace/pop进行处理，也不管。</li> <li>否则就把ignorePath清空，执行handlePop。handlePop的逻辑我们在下面会说。</li></ul></li> <li><p>revertPop</p> <p>这个方法是在有提示的时候，用户点击了取消的时候会调用的方法。先说这个方法的原因是因为handlePop方法里面有这个方法的逻辑。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 回滚路由地址
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">revertPop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fromLocation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> toLocation <span class="token operator">=</span> history<span class="token punctuation">.</span>location

  <span class="token comment">// TODO: We could probably make this more reliable by</span>
  <span class="token comment">// keeping a list of paths we've seen in sessionStorage.</span>
  <span class="token comment">// Instead, we just default to 0 for paths we don't know.</span>

  <span class="token keyword">let</span> toIndex <span class="token operator">=</span> allPaths<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token function">createPath</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>toIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    toIndex <span class="token operator">=</span> <span class="token number">0</span>

  <span class="token keyword">let</span> fromIndex <span class="token operator">=</span> allPaths<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token function">createPath</span><span class="token punctuation">(</span>fromLocation<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fromIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    fromIndex <span class="token operator">=</span> <span class="token number">0</span>

  <span class="token keyword">const</span> delta <span class="token operator">=</span> toIndex <span class="token operator">-</span> fromIndex

  <span class="token keyword">if</span> <span class="token punctuation">(</span>delta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    forceNextPop <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">// 这里其实会触发handlePop</span>
    <span class="token function">go</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里我们拿到的fromLocation实际上是一个旧的值，它是一个浏览器要过去但是不应该跳转过去的值（我们放handlePop的源码会看到，这个实际上是用户选择取消要回滚原来路径操作的值），toLocation是我们现在history对象中的值。所以这两个的值是不一样的（因为没有调用setState）。然后我们拿这两个地址，在我们记录的总路径里面去比较，算出来差值。然后如果有差值，那么我们的需要阻断标志就是true，然后回滚原来的位置。回滚原来位置时，由于哈希值变化了，会触发handlePop。关于allPaths的维护，会在push和replace里面看到。</p></li> <li><p>handlePop</p> <p>handlePop这里面其实是对全局的哈希变化的监听，由我们前面的分析可以得到，它实际上才是主要监听哈希值并执行的方法。下面我们看看源码吧。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/** 当哈希值变化的时候会走这里 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">handlePop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">location</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>forceNextPop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    forceNextPop <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token string">'POP'</span>
    transitionManager<span class="token punctuation">.</span><span class="token function">confirmTransitionTo</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> action<span class="token punctuation">,</span> getUserConfirmation<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ok</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果没有提示的情况，或者是用户确认了提示，则进行状态的变更</span>
        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> action<span class="token punctuation">,</span> location <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 否则有提示，用户点击了取消，就走回滚方法</span>
        <span class="token function">revertPop</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里我们又一次看到了阻断标志。这里的阻断标志为true的时候，就是我们上面提到的revertPop中变化而来的。</p> <ul><li>当阻断标志为true，那就证明了，用户取消了提示，不前进页面，原地刷新路由即可。</li> <li>否则变化动作标志为POP，因为我们对于REPLACE和PUSH的情况都单独处理了，不会出现这两种情况。然后我们需要去拿用户的提示状态，这个提示放在了我们之前的工具类里面（由block方法影响的，用的是同一个对象），这里面我们只关心回调的第四个参数的状态，如果是true，那就证明路由变化，需要刷新并通知，走setState。否则就是用户点击取消了，回滚路由。</li></ul></li> <li><p>pushHashPath</p> <p>这个就一行代码，只是变化了哈希值，没啥好说的。这里我们用到path的时候，传参已经被encodePath过了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">pushHashPath</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash <span class="token operator">=</span> path
</code></pre></div></li> <li><p>replaceHashPath</p> <p>这个上面有提到，是为了保证根据window.location.href获取的路径和encodePath后的路径的一致性，如果不一致用后者（这里其实没那么太理解，既然无论咋样都以后一个为准，那为啥要管前面呢？）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 替换哈希值，这里这样处理的原因，同样是为了兼容火狐
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">replaceHashPath</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hashIndex <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span>

  window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> hashIndex <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> hashIndex <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'#'</span> <span class="token operator">+</span> path
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>checkDOMListeners</p> <p>这里我们监测的是是否有监听函数，如果有监听函数，则开启监听方法，如果没有了，那就关闭。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/** 这里listen和block走的是这个方法，监听dom的变化
 *  里面需要处理的是哈希值的变化
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">checkDOMListeners</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">delta</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  listenerCount <span class="token operator">+=</span> delta
	<span class="token comment">// HashChangeEvent = 'hashchange'</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>listenerCount <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">addEventListener</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> HashChangeEvent<span class="token punctuation">,</span> handleHashChange<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>listenerCount <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">removeEventListener</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> HashChangeEvent<span class="token punctuation">,</span> handleHashChange<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>createLocation</p> <p>这个是在工具类的一个方法，但是由于也比较重要，所以拿出来讲。否则下面的push方法会看不太懂。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/** LocationUtils.js */</span>
<span class="token comment">/** 规范传入的路径，组装成一个location对象 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createLocation</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state<span class="token punctuation">,</span> key<span class="token punctuation">,</span> currentLocation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> location
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> path <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Two-arg form: push(path, state)</span>
    location <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token comment">// path是string的情况，就调用parsePath解析出location</span>
    location<span class="token punctuation">.</span>state <span class="token operator">=</span> state
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// One-arg form: push(location)</span>
    location <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>path <span class="token punctuation">}</span> <span class="token comment">// 否则location是个对象，需要进行处理</span>
    <span class="token comment">// 对pathname不存在的情况进行补充，确保规范</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>
      location<span class="token punctuation">.</span>pathname <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token comment">// 对search进行补充，确保规范</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>search<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'?'</span><span class="token punctuation">)</span>
        location<span class="token punctuation">.</span>search <span class="token operator">=</span> <span class="token string">'?'</span> <span class="token operator">+</span> location<span class="token punctuation">.</span>search
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      location<span class="token punctuation">.</span>search <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 对hash进行补充，确保规范</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'#'</span><span class="token punctuation">)</span>
        location<span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token string">'#'</span> <span class="token operator">+</span> location<span class="token punctuation">.</span>hash
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      location<span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果state存在，但是location上的没有带上，那就给它带上</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> location<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>
      location<span class="token punctuation">.</span>state <span class="token operator">=</span> state
  <span class="token punctuation">}</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理不规范的符号，例如emoji等</span>
    location<span class="token punctuation">.</span>pathname <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">URIError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">URIError</span><span class="token punctuation">(</span>
        <span class="token string">'Pathname &quot;'</span> <span class="token operator">+</span> location<span class="token punctuation">.</span>pathname <span class="token operator">+</span> <span class="token string">'&quot; could not be decoded. '</span> <span class="token operator">+</span>
        <span class="token string">'This is likely caused by an invalid percent-encoding.'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> e
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 存在key就给key</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    location<span class="token punctuation">.</span>key <span class="token operator">=</span> key
  <span class="token comment">// 如果传入了当前位置，则解析相对于当前位置的路径名，进行拼装</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentLocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Resolve incomplete/relative pathname relative to current location.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      location<span class="token punctuation">.</span>pathname <span class="token operator">=</span> currentLocation<span class="token punctuation">.</span>pathname
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      location<span class="token punctuation">.</span>pathname <span class="token operator">=</span> <span class="token function">resolvePathname</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">,</span> currentLocation<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// When there is no prior location and pathname is empty, set it to /</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      location<span class="token punctuation">.</span>pathname <span class="token operator">=</span> <span class="token string">'/'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 返回完整的位置对象</span>
  <span class="token keyword">return</span> location
<span class="token punctuation">}</span>
</code></pre></div><p>这里方法在try语句之前，分为了两个主要的分支，一种是path传的是string的情况，一种是path传的location对象({pathname:'',search:'',hash:'',state:''})。</p> <ul><li>如果path是string的话，就把path字符串转成location的格式，便于后面进行处理。</li> <li>如果path不是string而本来就是location格式的话，我无法保证他们的准确性，所以进行标准化处理。</li></ul> <p>然后我们统一处理完毕，拿到了一个location对象，开始对pathname进行格式化。如果有当前地址的情况，就基于当前地址来对路径进行补充，规范化处理，如果没有当前地址，且没有pathname的情况，那就给pathname赋值'/'。最后返回完整的路径对象。</p></li></ul></li> <li><p>push</p> <p>现在我们回过头来看push方法吧。就会清晰很多了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">push</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 哈希路由不支持state的变化，将被忽略  </span>
  <span class="token function">warning</span><span class="token punctuation">(</span>
    state <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token string">'Hash history cannot push state; it is ignored'</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// 动作定义为push</span>
  <span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token string">'PUSH'</span>
  <span class="token comment">// 拿到即将去的地址</span>
  <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">createLocation</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> history<span class="token punctuation">.</span>location<span class="token punctuation">)</span>

  transitionManager<span class="token punctuation">.</span><span class="token function">confirmTransitionTo</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> action<span class="token punctuation">,</span> getUserConfirmation<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ok</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ok<span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token comment">// 根据location拿到规范化的路径，这里做的就是各种拼接和转化及特殊情况的处理</span>
    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">createPath</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span>
    <span class="token comment">// 拿到正确的哈希值，encodePath需要完整路径，basename+path是完整路径</span>
    <span class="token keyword">const</span> encodedPath <span class="token operator">=</span> <span class="token function">encodePath</span><span class="token punctuation">(</span>basename <span class="token operator">+</span> path<span class="token punctuation">)</span>
    <span class="token comment">// 比较哈希值是否变化</span>
    <span class="token keyword">const</span> hashChanged <span class="token operator">=</span> <span class="token function">getHashPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> encodedPath

    <span class="token keyword">if</span> <span class="token punctuation">(</span>hashChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// We cannot tell if a hashchange was caused by a PUSH, so we'd</span>
      <span class="token comment">// rather setState here and ignore the hashchange. The caveat here</span>
      <span class="token comment">// is that other hash histories in the page will consider it a POP.</span>
      <span class="token comment">// 记录需要被忽略的路径，避免重复操作</span>
      ignorePath <span class="token operator">=</span> path
      <span class="token comment">// 直接变化路由的哈希值即可</span>
      <span class="token function">pushHashPath</span><span class="token punctuation">(</span>encodedPath<span class="token punctuation">)</span>
      <span class="token comment">// 最后一次出现之前地址的位置</span>
      <span class="token keyword">const</span> prevIndex <span class="token operator">=</span> allPaths<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token function">createPath</span><span class="token punctuation">(</span>history<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// 将之前地址（包含本身）之前的调用栈保留起来</span>
      <span class="token keyword">const</span> nextPaths <span class="token operator">=</span> allPaths<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> prevIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> prevIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token comment">// 在该调用栈里面放入最新的地址</span>
      nextPaths<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
      <span class="token comment">// 更新调用栈</span>
      allPaths <span class="token operator">=</span> nextPaths
      <span class="token comment">// 刷新路由</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> action<span class="token punctuation">,</span> location <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 否则提醒不能放入同一个路径</span>
      <span class="token function">warning</span><span class="token punctuation">(</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token string">'Hash history cannot PUSH the same path; a new entry will not be added to the history stack'</span>
      <span class="token punctuation">)</span>
      <span class="token comment">// 原地刷新</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>首先我们判断参数传参是否有state的变化，如果有则需要给出提示，因为哈希路由不支持state的变化。</li> <li>然后我们将action类型定义好为PUSH，location可以通过上面的createLocation方法来取得。</li> <li>我们还是用上面创建的确认是否跳转类来判断，如果非ok的情况，那就是存在提示且用户取消的情况，什么都不做就好。否则就是跳转到要去的地址， 那么就拿规范化的location，比较哈希值是否有变化。
<ul><li>如果有变化，那就记录一下ignorePath，防止handleHashChange处理，变化哈希值，记录之前地址在全局路由列表中所在的最后一次的位置，并截断之后的数据，只要之前的（包括本身），将新地址加进来，作为新的全局路由列表(allPaths)。并且刷新路由。</li> <li>如果没有变化，那就给出警告并原地刷新。</li></ul></li></ul></li> <li><p>replace</p> <p>replace和push大同小异，这里直接放源码了，不详细说明。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">replace</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">warning</span><span class="token punctuation">(</span>
    state <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token string">'Hash history cannot replace state; it is ignored'</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token string">'REPLACE'</span>
  <span class="token comment">// 获取一个规范的当前地址对象</span>
  <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">createLocation</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> history<span class="token punctuation">.</span>location<span class="token punctuation">)</span>

  transitionManager<span class="token punctuation">.</span><span class="token function">confirmTransitionTo</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> action<span class="token punctuation">,</span> getUserConfirmation<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ok</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ok<span class="token punctuation">)</span>
      <span class="token keyword">return</span>

    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">createPath</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span>
    <span class="token comment">// 拿到正确的哈希值，这里是basename+path是因为要比较#后面的完整路径</span>
    <span class="token keyword">const</span> encodedPath <span class="token operator">=</span> <span class="token function">encodePath</span><span class="token punctuation">(</span>basename <span class="token operator">+</span> path<span class="token punctuation">)</span>
    <span class="token comment">// 比较哈希值是否变化</span>
    <span class="token keyword">const</span> hashChanged <span class="token operator">=</span> <span class="token function">getHashPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> encodedPath

    <span class="token keyword">if</span> <span class="token punctuation">(</span>hashChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// We cannot tell if a hashchange was caused by a REPLACE, so we'd</span>
      <span class="token comment">// rather setState here and ignore the hashchange. The caveat here</span>
      <span class="token comment">// is that other hash histories in the page will consider it a POP.</span>
      <span class="token comment">// 记录当前的path   </span>
      ignorePath <span class="token operator">=</span> path
      <span class="token comment">// 替换地址</span>
      <span class="token function">replaceHashPath</span><span class="token punctuation">(</span>encodedPath<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 找到之前的地址存储</span>
    <span class="token keyword">const</span> prevIndex <span class="token operator">=</span> allPaths<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token function">createPath</span><span class="token punctuation">(</span>history<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 如果能找到，那就把这个位置直接替换</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
      allPaths<span class="token punctuation">[</span>prevIndex<span class="token punctuation">]</span> <span class="token operator">=</span> path
    <span class="token comment">// 刷新页面</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> action<span class="token punctuation">,</span> location <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>listen</p> <p>**其实我们讲history库的原因就是因为这个listen。**它依赖于我们提到的checkDomListener。看一下它的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">listen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">listener</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这个值是一个解绑的闭包，被调用的时候就会解绑。</span>
  <span class="token keyword">const</span> unlisten <span class="token operator">=</span> transitionManager<span class="token punctuation">.</span><span class="token function">appendListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
  <span class="token comment">// 调用listen的时候，会增加监听历史条目的改变事件</span>
  <span class="token function">checkDOMListeners</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token comment">// 调用listen后，如果这个值被赋给一个变量，然后执行这个变量的时候</span>
  <span class="token comment">// 那么一样，取消监听、解除listen。</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">checkDOMListeners</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">unlisten</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们在调用添加监听函数的时候，会拿到解绑监听函数。然后我们会记录监听的数目，在原有基础上加1，这样我们激活了前面的handleHashChange方法。调用监听函数的时候，返回值可以赋给一个变量作为解绑监听的函数，然后调用这个变量的时候，就执行了减少一个监听数目，并解绑监听的方法。</p></li> <li><p>block</p> <p>block和listen某种程度上来说是一回事。看一下它的源码就知道了，也是依赖于checkDomListener。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">block</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">prompt <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> unblock <span class="token operator">=</span> transitionManager<span class="token punctuation">.</span><span class="token function">setPrompt</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>
  <span class="token comment">// 调用block之后，isBlocked这个标志位会变成true。</span>
  <span class="token comment">// 并且开始监听历史条目的改变</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isBlocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 增加一个监听对象</span>
    <span class="token function">checkDOMListeners</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    isBlocked <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 调用block之后，如果这个值被赋给一个变量，然后再执行这个变量</span>
  <span class="token comment">// 那么就会解除block，并且执行unblock，清除prompt</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isBlocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isBlocked <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token comment">// 减少一个监听对象</span>
      <span class="token function">checkDOMListeners</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">unblock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当我们调用history.block的时候，如果不是阻塞状态的话，增加监听的数目，并且阻塞状态置为true，调用之后的返回值作为解除回调的函数。当解除回调的函数被调用的时候，如果是阻塞状态，就将阻塞状态还原，并减少监听的数目。然后清空提示。</p> <p>到这里我们的history库的部分讲差不多了，是不是有种恍如隔世的感觉？我们是从哪儿进来的？下面我们来回忆一下入口文件的内容，然后继续我们接下来的章节。</p></li></ul></li></ul> <h3 id="说一下renderroutes"><a href="#说一下renderroutes" class="header-anchor">#</a> 说一下renderRoutes</h3> <p>首先我们先再来看一下入口文件的内容。我们已经刚才解释完HashRouter里面干了什么。那么现在的内容就变成了Provider里面包裹的部分了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Provider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'mobx-react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HashRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-config'</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">'./config/route'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> stores <span class="token keyword">from</span> <span class="token string">'./config/stores'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'./styles/index.scss'</span><span class="token punctuation">;</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>HashRouter<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>Provider <span class="token punctuation">{</span><span class="token operator">...</span>stores<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token function">renderRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>HashRouter<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Provider将我们需要的stores都注入到了子组件里面去，提供了上下文，这里的使用方式其实可以参考前面的Provider的方式，大致功能一样，只不过做了一些特殊处理，有兴趣的可以参考我最后一个参考文档。这里不做详细说明。</p> <p>然后inject就能拿到这个stores里面的内容，获取这里面的存储的属性和方法。也跟我们使用useContext的方式差不多，只不过它进行了更加细致的一些处理。</p> <p>所以前面说的这些，其实不是我们这节要讲的正题。正题是renderRoutes这个函数是啥？以及它做了什么操作？先来看一下他接受的参数routes，这个是由我们的配置文件中导入进来的。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> routes<span class="token operator">:</span> RouteConfig<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function-variable function">loader</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'../layouts/NoSidebarLayout'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      loading<span class="token operator">:</span> Loading<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    routes<span class="token operator">:</span> <span class="token punctuation">[</span>      
      <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">'/home'</span><span class="token punctuation">,</span>
        exact<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        component<span class="token operator">:</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token function-variable function">loader</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'../pages/home'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          loading<span class="token operator">:</span> Loading<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>然后再看renderRoutes做的动作。实际上只不过是把我们拿到的routes配置进行了一遍遍历，如果有routes配置，就将这个内容作为Switch组件的children。如果没有，就是null。仅此而已。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Switch<span class="token punctuation">,</span> Route <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 这里的routes就是我们经常能看到的router.ts文件暴露的内容，也是我们路由的维护项</span>
<span class="token comment">// 我们很熟悉的path、exact、component属性都是需要传入这里</span>
<span class="token comment">// 然后进行渲染得到的路由，Switch组件是负责路由的匹配</span>
<span class="token comment">// 判断当前的路径符合哪个，就显示哪个</span>
<span class="token keyword">function</span> <span class="token function">renderRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> extraProps <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> switchProps <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> routes <span class="token operator">?</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>Switch <span class="token punctuation">{</span><span class="token operator">...</span>switchProps<span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token punctuation">{</span>
        routes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>Route
              key<span class="token operator">=</span><span class="token punctuation">{</span>route<span class="token punctuation">.</span>key <span class="token operator">||</span> i<span class="token punctuation">}</span>
              path<span class="token operator">=</span><span class="token punctuation">{</span>route<span class="token punctuation">.</span>path<span class="token punctuation">}</span>
              exact<span class="token operator">=</span><span class="token punctuation">{</span>route<span class="token punctuation">.</span>exact<span class="token punctuation">}</span>
              strict<span class="token operator">=</span><span class="token punctuation">{</span>route<span class="token punctuation">.</span>strict<span class="token punctuation">}</span>
              render<span class="token operator">=</span><span class="token punctuation">{</span>props <span class="token operator">=&gt;</span>
                route<span class="token punctuation">.</span>render <span class="token operator">?</span> <span class="token punctuation">(</span>
                  route<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>props<span class="token punctuation">,</span> <span class="token operator">...</span>extraProps<span class="token punctuation">,</span> route<span class="token operator">:</span> route <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>
                  <span class="token operator">&lt;</span>route<span class="token punctuation">.</span>component <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>extraProps<span class="token punctuation">}</span> route<span class="token operator">=</span><span class="token punctuation">{</span>route<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
            <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Switch<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> renderRoutes<span class="token punctuation">;</span>
</code></pre></div><p>详细的看一下Switch和Route组件里面都有啥。老样子，我们依旧只看主干代码，对警告等无关紧要的内容忽略掉。</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">/**
 * 用于渲染第一个匹配的Route的公共API
* The public API for rendering the first &lt;Route&gt; that matches.
*/</span>
<span class="token keyword">class</span> <span class="token class-name">Switch</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token comment">// context中可以拿到，history，location，match，staticContext属性，这个是我们从上面传下来的。</span>
      <span class="token operator">&lt;</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>location <span class="token operator">||</span> context<span class="token punctuation">.</span>location<span class="token punctuation">;</span>
          
          <span class="token keyword">let</span> element<span class="token punctuation">,</span> match<span class="token punctuation">;</span>
          
          React<span class="token punctuation">.</span>Children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span> <span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>match <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> React<span class="token punctuation">.</span><span class="token function">isValidElement</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              element <span class="token operator">=</span> child<span class="token punctuation">;</span>
              <span class="token keyword">const</span> path <span class="token operator">=</span> child<span class="token punctuation">.</span>props<span class="token punctuation">.</span>path <span class="token operator">||</span> child<span class="token punctuation">.</span>props<span class="token punctuation">.</span>from<span class="token punctuation">;</span>
              match <span class="token operator">=</span> path
                <span class="token operator">?</span> <span class="token function">matchPath</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token operator">...</span>child<span class="token punctuation">.</span>props<span class="token punctuation">,</span> path <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token operator">:</span> context<span class="token punctuation">.</span>match<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> match
            <span class="token operator">?</span> React<span class="token punctuation">.</span><span class="token function">cloneElement</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token punctuation">{</span> location<span class="token punctuation">,</span> <span class="token literal-property property">computedMatch</span><span class="token operator">:</span> match <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看上面的代码可能有点乱，我们来一点点捋一捋。</p> <ul><li>RouterContext.Consumer中我们可以拿到history，location，match，staticContext属性，这个是我们大的RouterContext中注入进来的。是我们可以直接拿到的，这个的内容我们可以通过context这个变量来取得。</li> <li>location这个变量的取值，是由于我们可以从属性外部传一个location属性，来指定我们匹配的location。当然默认的情况下是不传的，它就匹配上下文中传递下来的location。</li> <li>element是记录的需要遍历的子元素（这里是Route），match是我们匹配的时候需要传入的属性。</li> <li>对我们的所有Route对象进行遍历，然后当match==null的时候（<strong>这里注意undefined==null</strong>)，就去根据拿到的路径去匹配拿到match的值。这里为啥会取path或者from属性？这是因为Redirect组件没有path，只有from属性。所以这里的加载路径只能根据from来取。</li> <li>如果我们的match!=null的时候，那么if条件是一直进不去的，也就是空循环。因为我们已经找到了需要的match属性。</li> <li>然后我们将我们找到的Route(即element)和我们的属性进行组装，然后就拿到了最终的需要的结果。</li></ul> <h3 id="再看一下route组件"><a href="#再看一下route组件" class="header-anchor">#</a> 再看一下Route组件</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 判断子节点个数是否为0</span>
<span class="token keyword">function</span> <span class="token function">isEmptyChildren</span><span class="token punctuation">(</span><span class="token parameter">children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> React<span class="token punctuation">.</span>Children<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Route组件</span>
<span class="token keyword">class</span> <span class="token class-name">Route</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>location <span class="token operator">||</span> context<span class="token punctuation">.</span>location<span class="token punctuation">;</span> 
          <span class="token comment">// 其实在Switch中，我们已经传入了computedMatch。</span>
          <span class="token comment">// 如果找不到这个属性，那我就找path，重新计算一遍匹配的路径（其实computedMatch也算的是这玩意儿）</span>
          <span class="token comment">// 如果再找不到，那我就去取上下文的match</span>
          <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>computedMatch 
            <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>computedMatch <span class="token comment">// &lt;Switch&gt; already computed the match for us</span>
            <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>path
            <span class="token operator">?</span> <span class="token function">matchPath</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span>
            <span class="token operator">:</span> context<span class="token punctuation">.</span>match<span class="token punctuation">;</span>
          <span class="token comment">// 组合属性，准备传给子组件</span>
          <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>context<span class="token punctuation">,</span> location<span class="token punctuation">,</span> match <span class="token punctuation">}</span><span class="token punctuation">;</span>

          <span class="token comment">// 解构出来子节点、组件、render方法</span>
          <span class="token keyword">let</span> <span class="token punctuation">{</span> children<span class="token punctuation">,</span> component<span class="token punctuation">,</span> render <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>

          <span class="token comment">// 对子节点为空的处理</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isEmptyChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            children <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>RouterContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>props<span class="token punctuation">}</span><span class="token operator">&gt;</span>
              <span class="token punctuation">{</span>props<span class="token punctuation">.</span>match
                <span class="token operator">?</span> children
                  <span class="token operator">?</span> <span class="token keyword">typeof</span> children <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span>
                    <span class="token operator">?</span> <span class="token function">children</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
                    <span class="token operator">:</span> children
                  <span class="token operator">:</span> component
                  <span class="token operator">?</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> props<span class="token punctuation">)</span>
                  <span class="token operator">:</span> render
                  <span class="token operator">?</span> <span class="token function">render</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
                  <span class="token operator">:</span> <span class="token keyword">null</span>
                <span class="token operator">:</span> <span class="token keyword">typeof</span> children <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span>
                <span class="token operator">?</span> <span class="token function">children</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
                <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>RouterContext<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>继续一点点分析。</p> <ul><li>这里的location同样是可以从Route的属性传进来的，我们可以人为的干预让它本来不匹配的情况下，也能够让它进行匹配。如果没有显式传入location属性，那就是正常的从上下文取得的location。</li> <li>这里的match实际上我们已经从Switch组件中可以拿到了，所以先判断有没有属性中传过来的computedMatch。默认情况下是有的，但是万一没有的话，我们还可以从path属性加工一遍，获得同样的computedMatch。如果连path属性都没有，那就拜拜了您嘞，我就直接拿上下文中的match，也就是默认值。</li> <li>然后我们把上下文对象，location和match组装成一个对象，准备传给子组件。</li> <li>然后我们解构出来子组件、组件和渲染方法，做一下空值的判断。</li> <li>由我们上面对Switch组件的分析，match如果有的话，那就有且只有一个。
<ul><li>如果match属性存在的话，那我就执行children里面的函数。
<ul><li>执行children的函数的时候分两种情况，如果children是函数，那就把props传入进来，进行渲染，否则就代表它不是函数，其实也就是空节点。</li> <li>然后如果没有children，那也就是我们的最底层节点了。那就找component，然后把我们匹配的props和我们的component组装起来。</li> <li>然后component也没有，那就执行render。把props传入进来，进行渲染。</li></ul></li> <li>如果match不存在的话，且children是函数，那我也要把props传入进来，进行渲染。</li></ul></li> <li>所以这里我们可以得出一个渲染的顺序，同样的子组件优先级的顺序为：component &gt; render &gt; children。表面上看上去children优先级最高，实际上并不是。</li></ul> <p>其实我们在讲述的过程中忽略了一个问题，那就是核心的一个方法没有讲。我们是咋匹配上然后拿到具体的match值，这个过程并不得而知。下面我们就来看看这个核心的方法matchPath。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">matchPath</span><span class="token punctuation">(</span><span class="token parameter">pathname<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当配置项为数组或者字符串的时候，直接给一个path属性，值为配置项本身，并保存</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> options <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 解构出来path、exact、strict、sensitive的属性，这些如果有配置就解构出来，没有就给默认值</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> exact <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> strict <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> sensitive <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token comment">// 这一步操作是把路径变成统一的数组</span>
  <span class="token keyword">const</span> paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> paths<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">matched<span class="token punctuation">,</span> path</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果没有路径，且不为空字符串那就返回null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>path <span class="token operator">&amp;&amp;</span> path <span class="token operator">!==</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果有匹配的，那我就不找了，返回即可</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>matched<span class="token punctuation">)</span> <span class="token keyword">return</span> matched<span class="token punctuation">;</span>
    <span class="token comment">// 解构出来正则表达式和keys的值，下面有用</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> regexp<span class="token punctuation">,</span> keys <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compilePath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">end</span><span class="token operator">:</span> exact<span class="token punctuation">,</span>
      strict<span class="token punctuation">,</span>
      sensitive
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过路径去匹配正则表达式</span>
    <span class="token keyword">const</span> match <span class="token operator">=</span> regexp<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果没有匹配返回null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果匹配了，则解构出来url和其它的值</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>url<span class="token punctuation">,</span> <span class="token operator">...</span>values<span class="token punctuation">]</span> <span class="token operator">=</span> match<span class="token punctuation">;</span>
    <span class="token comment">// 是否精准匹配</span>
    <span class="token keyword">const</span> isExact <span class="token operator">=</span> pathname <span class="token operator">===</span> url<span class="token punctuation">;</span>
    <span class="token comment">// 如果有精准匹配的条件，但是实际上没有精准匹配，则返回null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exact <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isExact<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果上述的校验都通过，则返回最终结果</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      path<span class="token punctuation">,</span> <span class="token comment">// the path used to match</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> path <span class="token operator">===</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">&amp;&amp;</span> url <span class="token operator">===</span> <span class="token string">&quot;&quot;</span> <span class="token operator">?</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">:</span> url<span class="token punctuation">,</span> <span class="token comment">// the matched portion of the URL</span>
      isExact<span class="token punctuation">,</span> <span class="token comment">// whether or not we matched exactly</span>
      <span class="token literal-property property">params</span><span class="token operator">:</span> keys<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> key<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        memo<span class="token punctuation">[</span>key<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> values<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> memo<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>首先，我们对于options是字符串和数组的情况进行预处理，把他们都统一成带path属性的对象。</p></li> <li><p>然后，我们从options解构出来path、exact(头部匹配即匹配)、strict(必须完全匹配)、sensitive(区分大小写)四个属性，并拿到统一的path属性的值，并且将路径转为统一的数组。</p></li> <li><p>然后我们对路径进行计算，reduce里面就是查找的过程（有reduce不懂的伙伴可以查找下api，这里不做相关说明）。先看整体里面干了啥，初值为null。当我们找到这个值的时候，那我就把这个值返回回来，作为下一次的结果。</p> <ul><li><p>如果没有path且path不为空字符串的时候，那我就直接跳过这一次的查找。</p></li> <li><p>如果有匹配的，那我就直接返回已经匹配的即可，保证只匹配一次。</p></li> <li><p>然后根据strict、sensitive、exact属性，计算出来匹配出来的正则表达式和keys，这里的keys是动态路由的键值名的组合。(compilePath方法有点复杂，且依赖了第三方库，这里先不做详细说明吧)</p></li> <li><p>然后这里的match就是我们根据正则表达式匹配的路径。</p> <ul><li><p>如果没有匹配，则直接跳过本次查找，进行下一次。</p></li> <li><p>如果匹配了，则解构出来url和其它的属性。</p></li> <li><p>然后isExact是判断是否精准匹配的一个标志。这里的url是把动态路由标志排除掉之后的结果，如果它匹配上了，应该是和原来的pathname是相等的。这里举一个例子，重点说一下带动态路由的情况。</p> <img src="https://i.ibb.co/fpJHNM5/matchpath.png"> <p>上面这个例子我也是在网上找的，因为exec这个不是很熟悉，查了下mdn的文档才清楚，得到的第一个结果是全部的匹配，后面的都是括号中的分组捕获结果，而这个值刚好和我们需要的动态路由的属性值一样。所以url字段就是我们的第一个属性值，也就和pathname是相等的，第二个属性值...values，也就是我们其他的动态路由属性的属性值。</p></li></ul></li> <li><p>最后就是返回最终匹配的路由的值。params里面做的就是把我们获取到的键值数组和我们的...values组装起来，然后作为一个新的对象进行返回。</p></li></ul></li></ul> <h3 id="withrouter-react-router-hooks"><a href="#withrouter-react-router-hooks" class="header-anchor">#</a> WithRouter &amp;&amp; React Router Hooks</h3> <p>回到我们的下一个正题，需要看一下WithRouter的代码，看它具体做了什么工作，为啥就把不直接与路由相连的组件，就可以使用路由的方法了呢？</p> <p>如果我们弄清楚上面的代码的话，那这个看起来就变得非常非常简单了。看了下面的代码，我们就可以明白为啥能获取到Router提供的属性了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> hoistStatics <span class="token keyword">from</span> <span class="token string">&quot;hoist-non-react-statics&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> RouterContext <span class="token keyword">from</span> <span class="token string">&quot;./RouterContext.js&quot;</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * A public higher-order component to access the imperative API
 */</span>
<span class="token keyword">function</span> <span class="token function">withRouter</span><span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> displayName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">withRouter(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Component<span class="token punctuation">.</span>displayName <span class="token operator">||</span> Component<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">C</span> <span class="token operator">=</span> <span class="token parameter">props</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果想要设置被withRouter包裹的组件的ref，就使用wrappedComponentRef</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> wrappedComponentRef<span class="token punctuation">,</span> <span class="token operator">...</span>remainingProps <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token comment">// 这里还是利用我们上面Router中提供的上下文，把属性传递进来，即history，location，match，staticContext属性。</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>Component
              <span class="token punctuation">{</span><span class="token operator">...</span>remainingProps<span class="token punctuation">}</span>
              <span class="token punctuation">{</span><span class="token operator">...</span>context<span class="token punctuation">}</span> 
              ref<span class="token operator">=</span><span class="token punctuation">{</span>wrappedComponentRef<span class="token punctuation">}</span>
            <span class="token operator">/</span><span class="token operator">&gt;</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token constant">C</span><span class="token punctuation">.</span>displayName <span class="token operator">=</span> displayName<span class="token punctuation">;</span>
  <span class="token constant">C</span><span class="token punctuation">.</span>WrappedComponent <span class="token operator">=</span> Component<span class="token punctuation">;</span>
  <span class="token comment">// 当给组件添加一个HOC时，原来的组件会被一个container组件包裹，这意味着新的组件不会有任何的静态方法</span>
  <span class="token comment">// 为了解决这个问题，就可以在return之前，将静态方法拷贝到container组件上面。</span>
  <span class="token comment">// 使用hoistStatics这个库是想把高阶组件和静态方法聚合起来</span>
  <span class="token keyword">return</span> <span class="token function">hoistStatics</span><span class="token punctuation">(</span><span class="token constant">C</span><span class="token punctuation">,</span> Component<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> withRouter<span class="token punctuation">;</span>
</code></pre></div><p>下面我们再看看Hooks给我们提供的四个Router Hooks。其实他们每个方法里面都有一个版本的警告提示，如果判断组件不是函数的时候，会给出警告提示。不过这里为了简单，我把他们都删去了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> RouterContext <span class="token keyword">from</span> <span class="token string">&quot;./RouterContext.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> HistoryContext <span class="token keyword">from</span> <span class="token string">&quot;./HistoryContext.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> matchPath <span class="token keyword">from</span> <span class="token string">&quot;./matchPath.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> useContext <span class="token operator">=</span> React<span class="token punctuation">.</span>useContext<span class="token punctuation">;</span>

<span class="token comment">/** 获取history对象 **/</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里的HistoryContext，我们上面其实见过，这个上下文中，只有history对象的值，包含了若干属性。</span>
  <span class="token comment">// 这个是我们调用useHistory钩子能够拿到history对象值的原因。</span>
  <span class="token keyword">return</span> <span class="token function">useContext</span><span class="token punctuation">(</span>HistoryContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 获取location对象 **/</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 同理，这里的RouterContext，我们也见过，包含history，location，match，staticContext属性</span>
  <span class="token comment">// 我们拿到了这里的location属性</span>
  <span class="token keyword">return</span> <span class="token function">useContext</span><span class="token punctuation">(</span>RouterContext<span class="token punctuation">)</span><span class="token punctuation">.</span>location<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 获取路由参数，即动态路由 **/</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 同理，这里的RouterContext，我们也见过，包含history，location，match，staticContext属性</span>
  <span class="token comment">// 这里我们拿到了match属性</span>
  <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>RouterContext<span class="token punctuation">)</span><span class="token punctuation">.</span>match<span class="token punctuation">;</span>
  <span class="token comment">// 如果有match属性，则返回match属性里的参数，即动态路由里的值</span>
  <span class="token keyword">return</span> match <span class="token operator">?</span> match<span class="token punctuation">.</span>params <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 获取最接近匹配的路径的match对象 **/</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useRouteMatch</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">useLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>RouterContext<span class="token punctuation">)</span><span class="token punctuation">.</span>match<span class="token punctuation">;</span>
  <span class="token keyword">return</span> path <span class="token operator">?</span> <span class="token function">matchPath</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">,</span> path<span class="token punctuation">)</span> <span class="token operator">:</span> match<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h1> <p>1.<a href="https://github.com/remix-run/react-router" target="_blank" rel="noopener noreferrer">React-Router<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(https://github.com/remix-run/react-router)</p> <p>2.<a href="https://zhuanlan.zhihu.com/p/106042913" target="_blank" rel="noopener noreferrer">React Router源码浅析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(https://zhuanlan.zhihu.com/p/106042913)</p> <p>3.<a href="https://zhuanlan.zhihu.com/p/355075393" target="_blank" rel="noopener noreferrer">面试官，别再问我React-Router了！每一行源码我都看过了！<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(https://zhuanlan.zhihu.com/p/355075393)</p> <p>4.<a href="https://segmentfault.com/a/1190000023560665?sort=votes" target="_blank" rel="noopener noreferrer">手写React-Router源码，深入理解其原理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(https://segmentfault.com/a/1190000023560665?sort=votes)</p> <p>5.<a href="https://juejin.cn/post/6844904056805130254" target="_blank" rel="noopener noreferrer">react-router-config使用与路由鉴权<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(https://juejin.cn/post/6844904056805130254)</p> <p>6.<a href="https://stackoverflow.com/questions/45373742/detect-route-change-with-react-router" target="_blank" rel="noopener noreferrer">StackOverFlow-history库中listen和unlisten的解答<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(https://stackoverflow.com/questions/45373742/detect-route-change-with-react-router)</p> <p>7.<a href="https://segmentfault.com/a/1190000022592588" target="_blank" rel="noopener noreferrer">mobx-react中Provider和inject的使用与理解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(https://segmentfault.com/a/1190000022592588)</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">12/19/2021, 4:11:38 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/ReactHooks/LifeCycleAndFunction.html" class="prev">
        如何正确的理解函数组件的生命周期
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.dd524133.js" defer></script><script src="/blog/assets/js/2.5687907e.js" defer></script><script src="/blog/assets/js/10.bf869da4.js" defer></script>
  </body>
</html>
